import os
import re
import tempfile
import requests
import markdown
from fastapi import FastAPI, HTTPException
from fastapi.responses import FileResponse
from pydantic import BaseModel
from youtube_transcript_api import YouTubeTranscriptApi
from openai import OpenAI
from ebooklib import epub

app = FastAPI()

# ğŸ”‘ Railway ë³€ìˆ˜(Settings > Variables)ì— ì„¤ì •í•œ DEEPSEEK_API_KEYë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
# ë¡œì»¬ í…ŒìŠ¤íŠ¸ ì‹œì—ëŠ” ë‘ ë²ˆì§¸ ì¸ìì— í‚¤ë¥¼ ì§ì ‘ ë„£ì„ ìˆ˜ë„ ìˆì§€ë§Œ, ë°°í¬ ì‹œì—” í™˜ê²½ë³€ìˆ˜ê°€ í•„ìˆ˜ì…ë‹ˆë‹¤.
DEEPSEEK_API_KEY = os.environ.get("DEEPSEEK_API_KEY")

# DeepSeek í´ë¼ì´ì–¸íŠ¸ ì„¤ì • (OpenAI SDK í˜¸í™˜)
client = OpenAI(
    api_key=DEEPSEEK_API_KEY,
    base_url="https://api.deepseek.com"
)

class BookRequest(BaseModel):
    url: str

def get_video_title(url: str):
    """ìœ íŠœë¸Œ í˜ì´ì§€ì—ì„œ ì˜ìƒ ì œëª©ì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ (ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ ë°˜í™˜)"""
    try:
        response = requests.get(url)
        # ê°„ë‹¨í•˜ê²Œ title íƒœê·¸ ë‚´ìš©ì„ ê¸ì–´ì˜µë‹ˆë‹¤
        matches = re.findall(r'<title>(.*?)</title>', response.text)
        if matches:
            # " - YouTube" ê°™ì€ ë’·ë¶€ë¶„ ì œê±°
            return matches[0].replace(" - YouTube", "")
    except:
        pass
    return "YouTube Video Summary"

def extract_video_id(url: str):
    """URLì—ì„œ Video ID ì¶”ì¶œ (ì •ê·œì‹ ì‚¬ìš©)"""
    # ë‹¤ì–‘í•œ ìœ íŠœë¸Œ URL í¬ë§· ì§€ì› (youtu.be, watch?v= ë“±)
    regex = r"(?:v=|\/)([0-9A-Za-z_-]{11}).*"
    match = re.search(regex, url)
    if match:
        return match.group(1)
    return None

def create_epub_file(title: str, content_markdown: str, video_id: str):
    """AIê°€ ì“´ ë§ˆí¬ë‹¤ìš´ í…ìŠ¤íŠ¸ë¥¼ EPUB íŒŒì¼ë¡œ ë³€í™˜í•˜ì—¬ ì„ì‹œ ê²½ë¡œ ë°˜í™˜"""
    book = epub.EpubBook()
    
    # 1. ë©”íƒ€ë°ì´í„° ì„¤ì •
    book.set_identifier(video_id)
    book.set_title(title)
    book.set_language('ko')
    book.add_author('DeepSeek AI')

    # 2. ì±•í„° ìƒì„± (Markdown -> HTML ë³€í™˜)
    # ì½ê¸° í¸í•˜ë„ë¡ ê°„ë‹¨í•œ CSS ìŠ¤íƒ€ì¼ë„ ì ìš©ëœ HTMLë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
    html_content = markdown.markdown(content_markdown)
    
    c1 = epub.EpubHtml(title='Summary', file_name='chap_01.xhtml', lang='ko')
    c1.content = f"""
        <html>
        <head>
        <style>
            body {{ font-family: sans-serif; line-height: 1.6; }}
            h1, h2, h3 {{ color: #2c3e50; }}
            strong {{ color: #e74c3c; }}
            hr {{ border: 0; border-top: 1px solid #eee; margin: 20px 0; }}
            .metadata {{ color: gray; font-size: small; margin-top: 50px; }}
        </style>
        </head>
        <body>
            <h1>{title}</h1>
            <hr/>
            {html_content}
            <div class="metadata">
                <p>Original Video: https://youtu.be/{video_id}</p>
                <p>Generated by Tublisher with DeepSeek</p>
            </div>
        </body>
        </html>
    """
    
    book.add_item(c1)

    # 3. í•„ìˆ˜ êµ¬ì¡° (ëª©ì°¨, ë„¤ë¹„ê²Œì´ì…˜) ì¶”ê°€
    book.toc = (epub.Link('chap_01.xhtml', 'Summary', 'intro'), (c1, []))
    book.add_item(epub.EpubNcx())
    book.add_item(epub.EpubNav())
    book.spine = ['nav', c1]

    # 4. ì„ì‹œ íŒŒì¼ ìƒì„± ë° ì €ì¥
    # delete=Falseë¡œ ì„¤ì •í•˜ì—¬ íŒŒì¼ì„ ë‹«ì€ í›„ì—ë„ ì‚­ì œë˜ì§€ ì•Šê²Œ í•¨ (FastAPIê°€ ì „ì†¡í•´ì•¼ í•˜ë¯€ë¡œ)
    with tempfile.NamedTemporaryFile(delete=False, suffix=".epub") as tmp:
        epub.write_epub(tmp.name, book)
        return tmp.name

@app.get("/")
def read_root():
    return {"status": "Tublisher Factory is Running! ğŸ­"}

@app.post("/api/create_book")
async def create_book(request: BookRequest):
    print(f"ğŸ“¥ [ì£¼ë¬¸ ì ‘ìˆ˜] URL: {request.url}")
    
    video_id = extract_video_id(request.url)
    if not video_id:
        # ì•ˆë“œë¡œì´ë“œê°€ ì‹¤íŒ¨ ì²˜ë¦¬í•˜ë„ë¡ 400 ì—ëŸ¬ ë°˜í™˜
        raise HTTPException(status_code=400, detail="Invalid YouTube URL")

    try:
        # 1. ì˜ìƒ ì œëª© ê°€ì ¸ì˜¤ê¸°
        video_title = get_video_title(request.url)
        print(f"   ğŸ¬ ì œëª©: {video_title}")

        # 2. ìë§‰ ì¶”ì¶œ (í•œêµ­ì–´ -> ì˜ì–´ ìˆœ ì‹œë„)
        try:
            transcript_list = YouTubeTranscriptApi.get_transcript(video_id, languages=['ko', 'en'])
            # í…ìŠ¤íŠ¸ë§Œ ì­‰ ì´ì–´ ë¶™ì´ê¸°
            full_text = " ".join([entry['text'] for entry in transcript_list])
            print(f"   ğŸ“œ ìë§‰ ì¶”ì¶œ ì™„ë£Œ ({len(full_text)}ì)")
        except Exception:
            # ìë§‰ì´ ì•„ì˜ˆ ì—†ëŠ” ì˜ìƒì¸ ê²½ìš°, ì—ëŸ¬ ë‚´ìš©ìœ¼ë¡œ ì±…ì„ ë§Œë“¤ì–´ ë³´ëƒ„
            error_msg = "## ì‹¤íŒ¨: ì´ ì˜ìƒì—ëŠ” ìë§‰ì´ ì—†ìŠµë‹ˆë‹¤.\n\nìë™ ìƒì„± ìë§‰ì´ ì—†ê±°ë‚˜, ì ‘ê·¼ì´ ì œí•œëœ ì˜ìƒì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
            return FileResponse(
                path=create_epub_file(video_title, error_msg, video_id),
                filename=f"{video_id}_error.epub",
                media_type='application/epub+zip'
            )

        # 3. DeepSeekì—ê²Œ ì›ê³  ì‘ì„± ìš”ì²­
        # (ë¹„ìš© ë° ì†ë„ë¥¼ ê³ ë ¤í•´ ì•ë¶€ë¶„ 15,000ìë§Œ ì‚¬ìš©)
        input_text = full_text[:15000]
        
        system_prompt = """
        ë‹¹ì‹ ì€ ë² ìŠ¤íŠ¸ì…€ëŸ¬ ì „ë¬¸ ë„ì„œ í¸ì§‘ìì…ë‹ˆë‹¤.
        ì œê³µëœ ìœ íŠœë¸Œ ì˜ìƒì˜ ìë§‰(ìŠ¤í¬ë¦½íŠ¸)ì„ ë°”íƒ•ìœ¼ë¡œ, ë…ìê°€ ì½ê¸° í¸í•œ 'ì „ìì±… ì±•í„°' í˜•íƒœë¡œ ë‚´ìš©ì„ ì¬êµ¬ì„±í•˜ì„¸ìš”.
        
        [í•„ìˆ˜ ì§€ì¹¨]
        1. ë¬¸ì²´: êµ¬ì–´ì²´ë¥¼ ì™„ë²½í•œ ë¬¸ì–´ì²´(ì±… ì„œìˆ í˜•)ë¡œ ë‹¤ë“¬ìœ¼ì„¸ìš”. "í–ˆìŠµë‹ˆë‹¤" ëŒ€ì‹  "í•˜ì˜€ë‹¤" ë“±ì„ ì‚¬ìš©í•˜ì„¸ìš”.
        2. êµ¬ì¡°: **ì†Œì œëª©(Heading 2)** ì„ ì ê·¹ì ìœ¼ë¡œ ì‚¬ìš©í•˜ì—¬ ë‚´ìš©ì„ ë…¼ë¦¬ì ìœ¼ë¡œ ë‚˜ëˆ„ì„¸ìš”.
        3. í¬ë§·: Markdown í˜•ì‹ì„ ì‚¬ìš©í•˜ì„¸ìš”. ì¤‘ìš”í•œ í‚¤ì›Œë“œëŠ” **ë³¼ë“œì²´**ë¡œ ê°•ì¡°í•˜ì„¸ìš”.
        4. ë‚´ìš©: ìš”ì•½ì´ ì•„ë‹ˆë¼ 'ì§€ì‹ì˜ ì •ë¦¬'ì…ë‹ˆë‹¤. ë‚´ìš©ì„ ë„ˆë¬´ ì¤„ì´ì§€ ë§ê³  í’ë¶€í•˜ê²Œ ì„œìˆ í•˜ì„¸ìš”.
        """

        print("   ğŸ¤– DeepSeek ì§‘í•„ ì‹œì‘...")
        if DEEPSEEK_API_KEY:
            try:
                response = client.chat.completions.create(
                    model="deepseek-chat",
                    messages=[
                        {"role": "system", "content": system_prompt},
                        {"role": "user", "content": f"ë‹¤ìŒ ìë§‰ì„ ì±… ì›ê³ ë¡œ ë³€í™˜í•´ì¤˜:\n\n{input_text}"}
                    ],
                    stream=False
                )
                book_content = response.choices[0].message.content
            except Exception as e:
                print(f"   âŒ AI ì˜¤ë¥˜: {e}")
                book_content = f"## AI ì²˜ë¦¬ ì‹¤íŒ¨\n\nDeepSeek API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nError: {e}\n\n### ì›ë³¸ ìë§‰ ì¼ë¶€\n{input_text[:3000]}..."
        else:
            book_content = f"## API í‚¤ ëˆ„ë½\n\nRailway ë³€ìˆ˜ ì„¤ì •(Variables)ì— DEEPSEEK_API_KEYë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.\n\n### ì›ë³¸ ìë§‰ ì¼ë¶€\n{input_text[:3000]}..."

        # 4. EPUB ì œë³¸ ë° ë°œì†¡
        print("   ğŸ“š EPUB ì œë³¸ ì¤‘...")
        epub_path = create_epub_file(video_title, book_content, video_id)
        
        print("   ğŸš€ ë°°ì†¡ ì‹œì‘!")
        
        # ìƒì„±ëœ EPUB íŒŒì¼ì„ ì•ˆë“œë¡œì´ë“œ ì•±ìœ¼ë¡œ ìŠ¤íŠ¸ë¦¬ë° ì „ì†¡
        return FileResponse(
            path=epub_path,
            filename=f"summary_{video_id}.epub",
            media_type='application/epub+zip'
        )

    except Exception as e:
        print(f"âŒ ì¹˜ëª…ì  ì˜¤ë¥˜: {e}")
        # ì„œë²„ ë¡œê·¸ í™•ì¸ìš©
        raise HTTPException(status_code=500, detail=str(e))